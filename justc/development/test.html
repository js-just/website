<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>JUSTC browsers test</title>
    </head>
    <body>
        <div style="
            display: flex;
            justify-content: space-between;
            flex-direction: row;
            flex-wrap: nowrap;
        ">
            <div style="
                display: grid;
                justify-items: start;
                gap: 5px;
            ">
                <button onclick="exec()">Execute</button>
                <button onclick="pars()">Parse</button>
            </div>
            <button onclick="init()">Initialize</button>
            <div style="
                display: grid;
                justify-items: end;
                gap: 5px;
            ">
                <button onclick="pser()">Parser</button>
                <button onclick="lxer()">Lexer</button>
            </div>
        </div>
        <hr>
        <script src="justc.js"></script>
        <script>
            let savedCode = null;
            function code() {
                return window.JUSTC_MonacoEditor?.getModel()?.getValue() ?? prompt("Enter JUSTC Code");
            }
            function out(json) {
                const outstr = typeof json === "object" ? JSON.stringify(json) : String(json);
                if (monaco && window.JUSTC_MonacoEditor) {
                    const editor = window.JUSTC_MonacoEditor;
                    savedCode = editor.getModel().getValue();
                    monaco.editor.setModelLanguage(editor.getModel(), 'json');
                    editor.getModel().setValue(outstr);
                } else {
                    alert(outstr);
                }
            }
            function run(func) {
                const input = code();
                if (!input || input.length < 1) return;
                try {
                    const output = JUSTC[func](input);
                    out(typeof output === "object" ? JSON.stringify(output) : String(output));
                } catch (err) {
                    alert("Error: "+err);
                }
            }
            function exec() {
                run("execute");
            }
            function pars() {
                run("parse");
            }
            async function init() {
                try {
                    await JUSTC.initialize();
                    alert("Initialized.");
                } catch (err) {
                    alert("Failed: "+err);
                }
            }
            function pser() {
                try {
                    const output = JUSTC.requestPermissions('core.parser')(JSON.parse(code()));
                    out(typeof output === "object" ? JSON.stringify(output) : String(output));
                } catch (err) {
                    alert("Error: "+err);
                }
            }
            function lxer() {
                try {
                    const output = JUSTC.requestPermissions('core.lexer')(code());
                    out(typeof output === "object" ? JSON.stringify(output) : String(output));
                } catch (err) {
                    alert("Error: "+err);
                }
            }
            const wait = setInterval(()=>{
                if (document.documentElement.getAttribute('justc') != null && window.JUSTC_MonacoEditor) {
                    clearInterval(wait);
                    const editor = window.JUSTC_MonacoEditor;
                    editor.onDidType(()=>{
                        if (editor.getModel().getLanguageIdentifier().language === 'json') {
                            monaco.editor.setModelLanguage(editor.getModel(), 'justc');
                            editor.getModel().setValue(savedCode || '-- Type JUSTC code here...');
                        }
                    });
                }
            },100);
        </script>
        <script src="monaco.js"></script>
    </body>
</html>
